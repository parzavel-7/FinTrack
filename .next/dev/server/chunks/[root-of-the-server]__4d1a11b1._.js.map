{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/prac/PROJECTS/FinTrack/fin_track/src/app/api/ai-insights/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const data = await req.json();\r\n    const { transactions, goals, totals } = data;\r\n\r\n    const apiKey = process.env.OPENROUTER_API_KEY;\r\n    const appName = process.env.NEXT_PUBLIC_APP_NAME || \"FinTrack\";\r\n\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            \"OPENROUTER_API_KEY not configured. Please add it to your .env.local file.\",\r\n        },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const prompt = `\r\n      As a personal financial advisor, analyze the following financial data and provide 3-5 actionable insights.\r\n      \r\n      Financial Summary:\r\n      - Total Income: $${totals.income}\r\n      - Total Expenses: $${totals.expenses}\r\n      - Current Savings: $${totals.savings}\r\n      \r\n      Goals:\r\n      ${goals\r\n        .map(\r\n          (g: any) =>\r\n            `- ${g.name}: Target $${g.target_amount}, Current $${g.current_amount}, Status: ${g.status}`\r\n        )\r\n        .join(\"\\n\")}\r\n      \r\n      Recent Transactions:\r\n      ${transactions\r\n        .slice(0, 10)\r\n        .map(\r\n          (t: any) =>\r\n            `- ${t.date}: ${t.description || \"No description\"} ($${\r\n              t.amount\r\n            }) - ${t.type}`\r\n        )\r\n        .join(\"\\n\")}\r\n      \r\n      Respond STRICTLY in JSON format with the following structure:\r\n      {\r\n        \"insights\": [\r\n          {\r\n            \"id\": \"unique-id\",\r\n            \"type\": \"tip\" | \"warning\" | \"success\" | \"info\",\r\n            \"title\": \"Short title\",\r\n            \"description\": \"Explanatory text\",\r\n            \"category\": \"spending\" | \"savings\" | \"goals\" | \"general\",\r\n            \"actionLabel\": \"Optional button text\",\r\n            \"actionUrl\": \"Optional relative path\"\r\n          }\r\n        ],\r\n        \"summary\": \"A brief overview sentence of the financial health.\"\r\n      }\r\n    `;\r\n\r\n    const response = await fetch(\r\n      \"https://openrouter.ai/api/v1/chat/completions\",\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          Authorization: `Bearer ${apiKey}`,\r\n          \"HTTP-Referer\": \"https://github.com/google/fintrack\",\r\n          \"X-Title\": appName,\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          model: \"google/gemini-2.0-flash-001\",\r\n          messages: [\r\n            {\r\n              role: \"system\",\r\n              content:\r\n                \"You are a helpful financial assistant that provides concise, actionable insights in valid JSON format.\",\r\n            },\r\n            {\r\n              role: \"user\",\r\n              content: prompt,\r\n            },\r\n          ],\r\n          response_format: { type: \"json_object\" },\r\n        }),\r\n      }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      let errorDetail;\r\n      try {\r\n        errorDetail = JSON.parse(errorText);\r\n      } catch {\r\n        errorDetail = errorText;\r\n      }\r\n\r\n      console.error(\"OpenRouter API Error Status:\", response.status);\r\n      console.error(\"OpenRouter API Error Detail:\", errorDetail);\r\n\r\n      return NextResponse.json(\r\n        {\r\n          error: \"AI provider error\",\r\n          details:\r\n            errorDetail?.error?.message || \"Failed to fetch from AI provider\",\r\n        },\r\n        { status: response.status }\r\n      );\r\n    }\r\n\r\n    const result = await response.json();\r\n\r\n    if (!result.choices?.[0]?.message?.content) {\r\n      console.error(\"AI Provider Response missing content:\", result);\r\n      throw new Error(\"AI provider returned an empty or invalid response.\");\r\n    }\r\n\r\n    let aiContent;\r\n    try {\r\n      const rawContent = result.choices[0].message.content;\r\n      // More robust JSON parsing in case of markdown blocks\r\n      const jsonMatch = rawContent.match(/```json\\s*([\\s\\S]*?)\\s*```/);\r\n      const jsonString = jsonMatch ? jsonMatch[1] : rawContent;\r\n      aiContent = JSON.parse(jsonString);\r\n    } catch (parseError) {\r\n      console.error(\r\n        \"Error parsing AI response content:\",\r\n        result.choices[0].message.content\r\n      );\r\n      throw new Error(\"Failed to parse AI response into the expected format.\");\r\n    }\r\n\r\n    return NextResponse.json({\r\n      ...aiContent,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"AI Insights Route Error:\", error);\r\n    return NextResponse.json(\r\n      { error: error.message || \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}